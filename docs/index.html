<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>USA County Price Filter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,700&family=Manrope:wght@500;700;800&display=swap" rel="stylesheet">
  <style>
    html, body { height: 100%; margin: 0; }
    :root {
      --brand-navy: #0f3957;
      --brand-cyan: #2ab3d6;
      --brand-sky: #89cff2;
      --brand-foam: #ecf9ff;
      --brand-shadow: rgba(9, 42, 69, 0.2);
      --panel-bg: rgba(255, 255, 255, 0.93);
      --panel-border: rgba(15, 57, 87, 0.2);
      --panel-text: #10344d;
      --panel-muted: rgba(16, 52, 77, 0.68);
      --accent-green: #2f8a6a;
      --accent-green-soft: rgba(47, 138, 106, 0.2);
    }
    #wrap {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
      display: flex;
      background: linear-gradient(180deg, var(--brand-sky) 0%, #9fd3f2 56%, #93caed 100%);
    }
    #sidebar {
      width: 372px;
      min-width: 372px;
      max-width: 372px;
      height: 100%;
      box-sizing: border-box;
      padding: 16px 14px 14px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.92) 0%, rgba(255,255,255,0.84) 100%);
      backdrop-filter: blur(8px);
      border-right: 1px solid rgba(15, 57, 87, 0.14);
      box-shadow: 10px 0 24px rgba(9, 42, 69, 0.12);
      z-index: 2;
    }
    #brand {
      position: relative;
      display: flex;
      align-items: center;
      gap: 10px;
      color: #10344d;
      font-family: "Manrope", system-ui, -apple-system, Segoe UI, sans-serif;
    }
    #brand-mark {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: radial-gradient(circle at 28% 24%, #c9efe6 0%, #5ea9b9 38%, #1f567a 100%);
      position: relative;
      box-shadow: 0 8px 18px rgba(26, 78, 108, 0.34);
      overflow: hidden;
      flex: 0 0 44px;
    }
    #brand-mark::before {
      content: "";
      position: absolute;
      left: 8px;
      right: 8px;
      top: 9px;
      bottom: 9px;
      border: 2px solid rgba(255,255,255,0.9);
      border-radius: 999px 999px 18px 18px;
      transform: rotate(-12deg);
    }
    #brand-mark::after {
      content: "";
      position: absolute;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #fff;
      top: 17px;
      left: 17px;
      box-shadow: 0 0 0 3px rgba(255,255,255,0.35);
    }
    #brand-copy { text-align: left; }
    #brand h1 {
      margin: 0;
      font-family: "Fraunces", Georgia, serif;
      font-size: 40px;
      line-height: 1.1;
      letter-spacing: 0.2px;
      text-shadow: 0 1px 0 rgba(255,255,255,0.6);
      color: var(--brand-navy);
    }
    #brand p {
      margin: 1px 0 0;
      font-size: 15px;
      font-weight: 700;
      letter-spacing: 0.38px;
      color: rgba(15,57,87,0.74);
    }
    #ui {
      position: relative;
      width: 100%;
      box-sizing: border-box;
      flex: 1 1 auto;
      overflow: auto;
      padding: 16px 16px 14px;
      border-radius: 16px;
      border: 1px solid var(--panel-border);
      background: var(--panel-bg);
      box-shadow: 0 14px 34px rgba(13, 50, 75, 0.16);
      backdrop-filter: blur(9px);
      font-family: "Manrope", system-ui, -apple-system, Segoe UI, sans-serif;
      color: var(--panel-text);
      font-size: 16px;
      line-height: 1.35;
    }
    #ui::before {
      content: "";
      display: block;
      height: 2px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(47, 138, 106, 0.86), rgba(47, 138, 106, 0.24));
      margin-bottom: 12px;
    }
    .panel-title {
      font-size: 18px;
      font-weight: 800;
      letter-spacing: 0.2px;
      margin-bottom: 10px;
    }
    .filter-block {
      padding: 11px 10px 10px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.64);
      border: 1px solid rgba(15, 57, 87, 0.08);
      margin-top: 8px;
    }
    .filter-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
    }
    .filter-name {
      font-weight: 700;
      font-size: 14px;
      letter-spacing: 0.12px;
      color: var(--panel-text);
    }
    .filter-value {
      display: inline-block;
      margin-left: 4px;
      font-weight: 800;
      font-size: 14px;
      color: #0e5f7d;
    }
    #value { font-variant-numeric: tabular-nums; font-weight: 700; }
    #status {
      margin-top: 10px;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(236, 249, 255, 0.88);
      border: 1px solid rgba(15, 57, 87, 0.1);
      font-size: 13px;
      font-weight: 600;
      color: var(--panel-muted);
      white-space: pre-wrap;
    }
    #map {
      position: relative;
      flex: 1 1 auto;
      min-width: 0;
      height: 100%;
      z-index: 1;
    }
    .filter-note {
      margin-top: 6px;
      font-size: 11px;
      color: var(--panel-muted);
      line-height: 1.35;
    }
    .race-section-title {
      font-size: 14px;
      font-weight: 800;
      color: var(--panel-text);
      margin-bottom: 6px;
    }
    .race-subfilter {
      padding: 8px 8px 6px;
      border-radius: 10px;
      border: 1px solid rgba(15, 57, 87, 0.1);
      background: rgba(255, 255, 255, 0.6);
      margin-top: 8px;
    }
    .dual-range {
      position: relative;
      height: 30px;
      margin: 0;
      --min-pct: 0%;
      --max-pct: 100%;
    }
    .dual-range::before {
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      top: 13px;
      height: 4px;
      border-radius: 999px;
      background: linear-gradient(
        to right,
        #d8e3ea 0 var(--min-pct),
        var(--accent-green) var(--min-pct) var(--max-pct),
        #d8e3ea var(--max-pct) 100%
      );
      z-index: 0;
    }
    .dual-range.is-disabled::before {
      background: #d8e3ea;
    }
    .dual-range input[type="range"] {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      margin: 0;
      background: transparent;
      appearance: none;
      -webkit-appearance: none;
      accent-color: transparent;
      z-index: 1;
      pointer-events: none;
    }
    .dual-range input[type="range"]::-webkit-slider-runnable-track {
      height: 4px;
      background: transparent;
      border: 0;
    }
    .dual-range input[type="range"]::-moz-range-track {
      height: 4px;
      background: transparent;
      border: 0;
    }
    .dual-range input[type="range"]::-moz-range-progress {
      height: 4px;
      background: transparent;
    }
    .dual-range input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 2px solid #ffffff;
      background: var(--accent-green);
      box-shadow: 0 1px 3px rgba(0,0,0,0.25);
      margin-top: -5px;
      pointer-events: auto;
      position: relative;
      z-index: 2;
      cursor: pointer;
    }
    .dual-range.is-disabled input[type="range"]::-webkit-slider-thumb {
      background: #cad9e3;
      box-shadow: 0 1px 2px rgba(0,0,0,0.14);
    }
    .dual-range input[type="range"]::-moz-range-thumb {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 2px solid #ffffff;
      background: var(--accent-green);
      box-shadow: 0 1px 3px rgba(0,0,0,0.25);
      pointer-events: auto;
      position: relative;
      z-index: 2;
      cursor: pointer;
    }
    #ui .dual-range input[type="range"]:disabled {
      opacity: 1;
      filter: none;
    }
    .dual-range.is-disabled input[type="range"]::-moz-range-thumb {
      background: #cad9e3;
      box-shadow: 0 1px 2px rgba(0,0,0,0.14);
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 42px;
      height: 24px;
      flex: 0 0 auto;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .switch-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #cad9e3;
      transition: 0.2s;
      border-radius: 24px;
    }
    .switch-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      top: 3px;
      background-color: #fff;
      transition: 0.2s;
      border-radius: 50%;
      box-shadow: 0 1px 3px rgba(0,0,0,0.25);
    }
    .switch input:checked + .switch-slider {
      background-color: var(--accent-green);
    }
    .switch input:checked + .switch-slider:before {
      transform: translateX(18px);
    }
    #ui input[type="range"] {
      width: 100%;
      height: 30px;
      margin: 0;
      accent-color: var(--accent-green);
      cursor: pointer;
    }
    #ui input[type="range"]:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      filter: grayscale(0.25);
    }
    #tooltip {
      position: absolute;
      z-index: 3;
      pointer-events: none;
      display: none;
      width: 420px;
      padding: 16px 18px;
      border-radius: 14px;
      border: 1px solid rgba(16, 52, 77, 0.16);
      background: linear-gradient(180deg, rgba(255,255,255,0.98) 0%, rgba(250,253,255,0.97) 100%);
      color: #173b53;
      font-family: "Manrope", system-ui, -apple-system, Segoe UI, sans-serif;
      font-size: 19px;
      font-weight: 500;
      letter-spacing: 0.1px;
      line-height: 1.42;
      box-shadow: 0 14px 34px rgba(9, 42, 69, 0.24);
      backdrop-filter: blur(4px);
      box-sizing: border-box;
    }
    .tooltip-title {
      display: block;
      font-family: "Fraunces", Georgia, serif;
      font-size: 24px;
      line-height: 1.2;
      font-weight: 700;
      letter-spacing: 0.15px;
      color: #10344d;
      margin: -2px -2px 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(16, 52, 77, 0.18);
    }
    .tooltip-row {
      display: block;
      margin: 1px 0;
    }
    .tooltip-label {
      font-weight: 750;
      color: #17435d;
    }
    .tooltip-value {
      font-weight: 500;
      color: #173b53;
    }
    @media (max-width: 800px) {
      #wrap {
        flex-direction: column;
      }
      #sidebar {
        width: 100%;
        min-width: 0;
        max-width: none;
        height: auto;
        border-right: none;
        border-bottom: 1px solid rgba(15, 57, 87, 0.14);
        box-shadow: 0 8px 20px rgba(9, 42, 69, 0.12);
      }
      #ui {
        width: 100%;
        font-size: 16px;
        padding: 12px 14px;
        max-height: 50vh;
      }
      #status { font-size: 14px; }
      #tooltip {
        width: min(90vw, 440px);
        font-size: 19px;
      }
      #brand h1 { font-size: 34px; }
      #map { min-height: 50vh; }
    }
    svg { width: 100%; height: 100%; display: block; }
    .county { vector-effect: non-scaling-stroke; }
    .county.hovered {
      fill: #fdd835 !important;
      stroke: #111 !important;
      stroke-width: 1.4 !important;
      filter: brightness(1.08);
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
</head>
<body>
<div id="wrap">
  <div id="sidebar">
    <div id="brand">
      <div id="brand-mark"></div>
      <div id="brand-copy">
        <h1>MoveMap</h1>
        <p>Move Somewhere Livable</p>
      </div>
    </div>
    <div id="ui">
      <div class="panel-title">U.S. Counties with</div>
      <div class="filter-block">
        <div class="filter-header">
          <div class="filter-name">
            Median home price below
            <span class="filter-value" id="priceValue">$500,000</span>
          </div>
          <label class="switch" aria-label="Toggle home price filter">
            <input id="priceOn" type="checkbox" checked />
            <span class="switch-slider"></span>
          </label>
        </div>
        <input id="priceSlider" type="range" min="0" max="3000000" step="25000" value="500000" />
      </div>
      <div class="filter-block">
        <div class="filter-header">
          <div class="filter-name">
            Life expectancy at least
            <span class="filter-value" id="lifeValue">76.0 years</span>
          </div>
          <label class="switch" aria-label="Toggle life expectancy filter">
            <input id="lifeOn" type="checkbox" />
            <span class="switch-slider"></span>
          </label>
        </div>
        <input id="lifeSlider" type="range" min="55" max="95" step="0.1" value="76.0" />
      </div>
      <div class="filter-block">
        <div class="filter-header">
          <div class="filter-name">
            Minimum wage at least
            <span class="filter-value" id="wageValue">$7.25</span>
          </div>
          <label class="switch" aria-label="Toggle minimum wage filter">
            <input id="wageOn" type="checkbox" />
            <span class="switch-slider"></span>
          </label>
        </div>
        <input id="wageSlider" type="range" min="7" max="25" step="0.25" value="7.25" />
      </div>
      <div class="filter-block">
        <div class="filter-header">
          <div class="filter-name">
            Homicide rate below (per 100k)
            <span class="filter-value" id="homicideValue">10.0</span>
          </div>
          <label class="switch" aria-label="Toggle homicide filter">
            <input id="homicideOn" type="checkbox" />
            <span class="switch-slider"></span>
          </label>
        </div>
        <input id="homicideSlider" type="range" min="0" max="50" step="0.5" value="10.0" />
        <div class="filter-note">Safe: &lt; 5, Average: 5&ndash;15, Violent: &gt; 15</div>
        <div class="filter-note">Source: IHME county homicide rate (2019, all ages)</div>
      </div>
      <div class="filter-block">
        <div class="filter-header">
          <div class="filter-name">
            County population between
            <span class="filter-value" id="populationValue">0 - 3,000,000</span>
          </div>
          <label class="switch" aria-label="Toggle county population filter">
            <input id="populationOn" type="checkbox" />
            <span class="switch-slider"></span>
          </label>
        </div>
        <div class="dual-range">
          <input id="populationMin" type="range" min="0" max="3000000" step="10000" value="0" />
          <input id="populationMax" type="range" min="0" max="3000000" step="10000" value="3000000" />
        </div>
      </div>
      <div class="filter-block">
        <div class="race-section-title">Race share between</div>
        <div class="race-subfilter">
          <div class="filter-header">
            <div class="filter-name">
              White
              <span class="filter-value" id="whiteRaceValue">0.0% - 100.0%</span>
            </div>
            <label class="switch" aria-label="Toggle white race filter">
              <input id="whiteRaceOn" type="checkbox" />
              <span class="switch-slider"></span>
            </label>
          </div>
          <div class="dual-range">
            <input id="whiteRaceMin" type="range" min="0" max="100" step="0.1" value="0" />
            <input id="whiteRaceMax" type="range" min="0" max="100" step="0.1" value="100" />
          </div>
        </div>
        <div class="race-subfilter">
          <div class="filter-header">
            <div class="filter-name">
              Black
              <span class="filter-value" id="blackRaceValue">0.0% - 100.0%</span>
            </div>
            <label class="switch" aria-label="Toggle black race filter">
              <input id="blackRaceOn" type="checkbox" />
              <span class="switch-slider"></span>
            </label>
          </div>
          <div class="dual-range">
            <input id="blackRaceMin" type="range" min="0" max="100" step="0.1" value="0" />
            <input id="blackRaceMax" type="range" min="0" max="100" step="0.1" value="100" />
          </div>
        </div>
        <div class="race-subfilter">
          <div class="filter-header">
            <div class="filter-name">
              Asian
              <span class="filter-value" id="asianRaceValue">0.0% - 100.0%</span>
            </div>
            <label class="switch" aria-label="Toggle asian race filter">
              <input id="asianRaceOn" type="checkbox" />
              <span class="switch-slider"></span>
            </label>
          </div>
          <div class="dual-range">
            <input id="asianRaceMin" type="range" min="0" max="100" step="0.1" value="0" />
            <input id="asianRaceMax" type="range" min="0" max="100" step="0.1" value="100" />
          </div>
        </div>
        <div class="race-subfilter">
          <div class="filter-header">
            <div class="filter-name">
              Hispanic
              <span class="filter-value" id="hispanicRaceValue">0.0% - 100.0%</span>
            </div>
            <label class="switch" aria-label="Toggle hispanic race filter">
              <input id="hispanicRaceOn" type="checkbox" />
              <span class="switch-slider"></span>
            </label>
          </div>
          <div class="dual-range">
            <input id="hispanicRaceMin" type="range" min="0" max="100" step="0.1" value="0" />
            <input id="hispanicRaceMax" type="range" min="0" max="100" step="0.1" value="100" />
          </div>
        </div>
      </div>
      <div id="status">Loading...</div>
    </div>
  </div>
  <div id="map"></div>
  <div id="tooltip"></div>
</div>

<script>
(function(){
  const fmt = (n) => '$' + Number(n).toLocaleString('en-US');
  const stateNameByFipsPrefix = {
    "01":"Alabama","02":"Alaska","04":"Arizona","05":"Arkansas","06":"California","08":"Colorado","09":"Connecticut",
    "10":"Delaware","11":"District of Columbia","12":"Florida","13":"Georgia","15":"Hawaii","16":"Idaho","17":"Illinois",
    "18":"Indiana","19":"Iowa","20":"Kansas","21":"Kentucky","22":"Louisiana","23":"Maine","24":"Maryland","25":"Massachusetts",
    "26":"Michigan","27":"Minnesota","28":"Mississippi","29":"Missouri","30":"Montana","31":"Nebraska","32":"Nevada",
    "33":"New Hampshire","34":"New Jersey","35":"New Mexico","36":"New York","37":"North Carolina","38":"North Dakota",
    "39":"Ohio","40":"Oklahoma","41":"Oregon","42":"Pennsylvania","44":"Rhode Island","45":"South Carolina","46":"South Dakota",
    "47":"Tennessee","48":"Texas","49":"Utah","50":"Vermont","51":"Virginia","53":"Washington","54":"West Virginia",
    "55":"Wisconsin","56":"Wyoming","72":"Puerto Rico"
  };
  // Some county datasets still use retired FIPS codes. Map them to current equivalents.
  const legacyFipsAlias = {
    "46113": "46102", // Shannon County, SD -> Oglala Lakota County, SD
    "02270": "02158"  // Wade Hampton CA, AK -> Kusilvak CA, AK
  };
  const lsadLabel = (lsad) => {
    const t = String(lsad || "").trim().toUpperCase();
    if (!t) return "";
    if (t === "CA") return "Census Area";
    if (t === "B") return "Borough";
    return lsad;
  };
  const priceSlider = document.getElementById('priceSlider');
  const lifeSlider = document.getElementById('lifeSlider');
  const wageSlider = document.getElementById('wageSlider');
  const homicideSlider = document.getElementById('homicideSlider');
  const populationMinEl = document.getElementById('populationMin');
  const populationMaxEl = document.getElementById('populationMax');
  const whiteRaceMinEl = document.getElementById('whiteRaceMin');
  const whiteRaceMaxEl = document.getElementById('whiteRaceMax');
  const blackRaceMinEl = document.getElementById('blackRaceMin');
  const blackRaceMaxEl = document.getElementById('blackRaceMax');
  const asianRaceMinEl = document.getElementById('asianRaceMin');
  const asianRaceMaxEl = document.getElementById('asianRaceMax');
  const hispanicRaceMinEl = document.getElementById('hispanicRaceMin');
  const hispanicRaceMaxEl = document.getElementById('hispanicRaceMax');
  const priceOnEl = document.getElementById('priceOn');
  const lifeOnEl = document.getElementById('lifeOn');
  const wageOnEl = document.getElementById('wageOn');
  const homicideOnEl = document.getElementById('homicideOn');
  const populationOnEl = document.getElementById('populationOn');
  const whiteRaceOnEl = document.getElementById('whiteRaceOn');
  const blackRaceOnEl = document.getElementById('blackRaceOn');
  const asianRaceOnEl = document.getElementById('asianRaceOn');
  const hispanicRaceOnEl = document.getElementById('hispanicRaceOn');
  const priceValueEl = document.getElementById('priceValue');
  const lifeValueEl = document.getElementById('lifeValue');
  const wageValueEl = document.getElementById('wageValue');
  const homicideValueEl = document.getElementById('homicideValue');
  const populationValueEl = document.getElementById('populationValue');
  const whiteRaceValueEl = document.getElementById('whiteRaceValue');
  const blackRaceValueEl = document.getElementById('blackRaceValue');
  const asianRaceValueEl = document.getElementById('asianRaceValue');
  const hispanicRaceValueEl = document.getElementById('hispanicRaceValue');
  const statusEl = document.getElementById('status');
  const tooltipEl = document.getElementById('tooltip');
  priceValueEl.textContent = fmt(priceSlider.value);
  lifeValueEl.textContent = `${Number(lifeSlider.value).toFixed(1)} years`;
  wageValueEl.textContent = fmt(Number(wageSlider.value).toFixed(2));
  homicideValueEl.textContent = `${Number(homicideSlider.value).toFixed(1)}`;
  populationValueEl.textContent = `${Number(populationMinEl.value).toLocaleString('en-US')} - ${Number(populationMaxEl.value).toLocaleString('en-US')}`;
  whiteRaceValueEl.textContent = `${Number(whiteRaceMinEl.value).toFixed(1)}% - ${Number(whiteRaceMaxEl.value).toFixed(1)}%`;
  blackRaceValueEl.textContent = `${Number(blackRaceMinEl.value).toFixed(1)}% - ${Number(blackRaceMaxEl.value).toFixed(1)}%`;
  asianRaceValueEl.textContent = `${Number(asianRaceMinEl.value).toFixed(1)}% - ${Number(asianRaceMaxEl.value).toFixed(1)}%`;
  hispanicRaceValueEl.textContent = `${Number(hispanicRaceMinEl.value).toFixed(1)}% - ${Number(hispanicRaceMaxEl.value).toFixed(1)}%`;

  const mapEl = document.getElementById('map');
  const width = Math.max(1, mapEl.clientWidth || window.innerWidth);
  const height = Math.max(1, mapEl.clientHeight || window.innerHeight);

  const svg = d3.select("#map").append("svg")
    .attr("viewBox", `0 0 ${width} ${height}`);

  const g = svg.append("g");

  const panMargin = 220;
  const zoom = d3.zoom()
    .scaleExtent([1, 20])
    .extent([[0, 0], [width, height]])
    .translateExtent([[-panMargin, -panMargin], [width + panMargin, height + panMargin]])
    .on("zoom", (event) => g.attr("transform", event.transform));

  svg.call(zoom);

  function parsePricesTSV(text) {
    // TSV: fips<TAB>price
    const prices = new Map();
    const lines = text.split(/\r?\n/);
    for (const line of lines) {
      if (!line.trim() || line.trim().startsWith("#")) continue;
      const parts = line.split(/\t/);
      if (parts.length < 2) continue;
      const fips = parts[0].trim();
      const price = Number(parts[1].trim());
      if (!/^\d{5}$/.test(fips)) continue;
      if (!Number.isFinite(price)) continue;
      prices.set(fips, price);
    }
    return prices;
  }

  function parseLifeTSV(text) {
    const life = new Map();
    const lines = text.split(/\r?\n/);
    for (const line of lines) {
      if (!line.trim() || line.trim().startsWith("#")) continue;
      const parts = line.split(/\t/);
      if (parts.length < 2) continue;
      const fips = parts[0].trim();
      const years = Number(parts[1].trim());
      if (!/^\d{5}$/.test(fips)) continue;
      if (!Number.isFinite(years)) continue;
      life.set(fips, years);
    }
    return life;
  }

  function parseWageTSV(text) {
    const wage = new Map();
    const lines = text.split(/\r?\n/);
    for (const line of lines) {
      if (!line.trim() || line.trim().startsWith("#")) continue;
      const parts = line.split(/\t/);
      if (parts.length < 2) continue;
      const fips = parts[0].trim();
      const amount = Number(parts[1].trim());
      if (!/^\d{5}$/.test(fips)) continue;
      if (!Number.isFinite(amount)) continue;
      wage.set(fips, amount);
    }
    return wage;
  }

  function parseHomicideTSV(text) {
    const homicide = new Map();
    const lines = text.split(/\r?\n/);
    for (const line of lines) {
      if (!line.trim() || line.trim().startsWith("#")) continue;
      const parts = line.split(/\t/);
      if (parts.length < 2) continue;
      const fips = parts[0].trim();
      const rate = Number(parts[1].trim());
      if (!/^\d{5}$/.test(fips)) continue;
      if (!Number.isFinite(rate)) continue;
      homicide.set(fips, rate);
    }
    return homicide;
  }

  function parseRaceTSV(text) {
    const race = new Map();
    const lines = text.split(/\r?\n/);
    for (const line of lines) {
      if (!line.trim() || line.trim().startsWith("#")) continue;
      const parts = line.split(/\t/);
      if (parts.length < 5) continue;
      const fips = parts[0].trim();
      const white = Number(parts[1].trim());
      const black = Number(parts[2].trim());
      const asian = Number(parts[3].trim());
      const hispanic = Number(parts[4].trim());
      if (!/^\d{5}$/.test(fips)) continue;
      if (![white, black, asian, hispanic].every(Number.isFinite)) continue;
      race.set(fips, { white, black, asian, hispanic });
    }
    return race;
  }

  function parsePopulationTSV(text) {
    const pop = new Map();
    const lines = text.split(/\r?\n/);
    for (const line of lines) {
      if (!line.trim() || line.trim().startsWith("#")) continue;
      const parts = line.split(/\t/);
      if (parts.length < 2) continue;
      const fips = parts[0].trim();
      const value = Number(parts[1].trim());
      if (!/^\d{5}$/.test(fips)) continue;
      if (!Number.isFinite(value)) continue;
      pop.set(fips, value);
    }
    return pop;
  }

  function setStatus(msg) { statusEl.textContent = msg; }
  function normalizeRange(minEl, maxEl) {
    let min = Number(minEl.value);
    let max = Number(maxEl.value);
    if (min > max) {
      const t = min;
      min = max;
      max = t;
      minEl.value = String(min);
      maxEl.value = String(max);
    }
    return [min, max];
  }
  function updateDualRangeFill(minEl, maxEl) {
    const wrap = minEl.closest(".dual-range");
    if (!wrap) return;
    const minVal = Number(minEl.min || 0);
    const maxVal = Number(minEl.max || 100);
    const span = Math.max(1e-9, maxVal - minVal);
    const low = ((Number(minEl.value) - minVal) / span) * 100;
    const high = ((Number(maxEl.value) - minVal) / span) * 100;
    wrap.style.setProperty("--min-pct", `${Math.max(0, Math.min(100, low))}%`);
    wrap.style.setProperty("--max-pct", `${Math.max(0, Math.min(100, high))}%`);
  }
  function placeTooltip(event) {
    const gap = 14;
    const edge = 8;
    const rect = tooltipEl.getBoundingClientRect();
    let left = event.clientX + gap;
    let top = event.clientY + gap;
    if (left + rect.width > window.innerWidth - edge) {
      left = event.clientX - gap - rect.width;
    }
    if (left < edge) left = edge;
    if (top + rect.height > window.innerHeight - edge) {
      top = event.clientY - gap - rect.height;
    }
    if (top < edge) top = edge;
    tooltipEl.style.left = `${left}px`;
    tooltipEl.style.top = `${top}px`;
  }

  function fetchJsonAny(paths) {
    let idx = 0;
    const tryNext = () => {
      if (idx >= paths.length) {
        throw new Error(`Failed to load JSON from: ${paths.join(", ")}`);
      }
      const path = paths[idx++];
      return fetch(path).then(r => {
        if (!r.ok) {
          return tryNext();
        }
        return r.json();
      }).catch(() => tryNext());
    };
    return tryNext();
  }

  function fetchTextAny(paths) {
    let idx = 0;
    const tryNext = () => {
      if (idx >= paths.length) {
        throw new Error(`Failed to load text from: ${paths.join(", ")}`);
      }
      const path = paths[idx++];
      return fetch(path).then(r => {
        if (!r.ok) {
          return tryNext();
        }
        return r.text();
      }).catch(() => tryNext());
    };
    return tryNext();
  }

  Promise.all([
    fetchJsonAny(["data/counties-10m.json", "/counties.json"]),
    fetchJsonAny(["data/counties-hires.geojson", "/counties-hires.json"]).catch(() => null),
    fetchTextAny(["data/prices.tsv", "/prices.tsv"]),
    fetchTextAny(["data/life_expectancy.tsv", "/life_expectancy.tsv"]),
    fetchTextAny(["data/minimum_wage.tsv", "/minimum_wage.tsv"]),
    fetchTextAny(["data/homicide_rate.tsv", "/homicide_rate.tsv"]),
    fetchTextAny(["data/race_data.tsv", "/race_data.tsv"]),
    fetchTextAny(["data/population.tsv", "/population.tsv"])
  ]).then(([topology, hiresGeo, pricesText, lifeText, wageText, homicideText, raceText, populationText]) => {
    const prices = parsePricesTSV(pricesText);
    const life = parseLifeTSV(lifeText);
    const wage = parseWageTSV(wageText);
    const homicide = parseHomicideTSV(homicideText);
    const race = parseRaceTSV(raceText);
    const population = parsePopulationTSV(populationText);

    const countiesObj = topology.objects && (topology.objects.counties || topology.objects.county);
    if (!countiesObj) {
      throw new Error("TopoJSON missing objects.counties (download counties-10m.json from us-atlas as instructed).");
    }

    const countiesRaw = (hiresGeo && hiresGeo.type === "FeatureCollection")
      ? hiresGeo
      : topojson.feature(topology, countiesObj);
    const counties = countiesRaw;

    const projection = d3.geoAlbersUsa().fitSize([width, height], counties);
    const path = d3.geoPath(projection);

    function isCityEquivalent(f) {
      const lsad = f.properties && f.properties.LSAD ? String(f.properties.LSAD).toLowerCase() : "";
      const rawName = f.properties && (f.properties.name || f.properties.NAME)
        ? String(f.properties.name || f.properties.NAME).trim()
        : "";
      return lsad === "city" || / city$/i.test(rawName) || / city and borough$/i.test(rawName);
    }

    for (const f of counties.features) {
      const rawId = String(f.id).padStart(5, "0");
      const id = legacyFipsAlias[rawId] || rawId;
      f.properties = f.properties || {};
      f.properties.fips = id;
      f.properties.isCity = isCityEquivalent(f);
      f.properties.price = prices.has(id) ? prices.get(id) : (prices.has(rawId) ? prices.get(rawId) : null);
      f.properties.life = life.has(rawId) ? life.get(rawId) : (life.has(id) ? life.get(id) : null);
      f.properties.wage = wage.has(id) ? wage.get(id) : (wage.has(rawId) ? wage.get(rawId) : null);
      f.properties.homicide = homicide.has(id) ? homicide.get(id) : (homicide.has(rawId) ? homicide.get(rawId) : null);
      f.properties.race = race.get(id) || race.get(rawId) || null;
      f.properties.population = population.has(id) ? population.get(id) : (population.has(rawId) ? population.get(rawId) : null);
    }

    const countyFeatures = counties.features.filter(f => !f.properties.isCity);
    const totalCounties = countyFeatures.length;

    // Make city-equivalent polygons visually disappear as separate units by inheriting
    // nearest county values from the same state.
    const countiesByState = new Map();
    for (const f of countyFeatures) {
      const st = String(f.properties.fips).slice(0, 2);
      if (!countiesByState.has(st)) countiesByState.set(st, []);
      countiesByState.get(st).push(f);
    }
    for (const city of counties.features.filter(f => f.properties.isCity)) {
      const st = String(city.properties.fips).slice(0, 2);
      const candidates = countiesByState.get(st) || [];
      if (candidates.length === 0) continue;
      const center = d3.geoCentroid(city);
      let best = candidates[0];
      let bestDist = Infinity;
      for (const c of candidates) {
        const d = d3.geoDistance(center, d3.geoCentroid(c));
        if (d < bestDist) {
          bestDist = d;
          best = c;
        }
      }
      city.properties.price = best.properties.price;
      city.properties.life = best.properties.life;
      city.properties.wage = best.properties.wage;
      city.properties.homicide = best.properties.homicide;
      city.properties.race = best.properties.race;
      city.properties.population = best.properties.population;
      city.properties.parentFips = best.properties.fips;
      city.properties.displayName = (best.properties && (best.properties.name || best.properties.NAME))
        ? String(best.properties.name || best.properties.NAME).trim()
        : null;
      city.properties.displayLSAD = (best.properties && best.properties.LSAD)
        ? String(best.properties.LSAD).trim()
        : null;
    }

    let stateBorderPath = null;
    const featureGroupFips = (d) => (d.properties && d.properties.isCity && d.properties.parentFips)
      ? String(d.properties.parentFips)
      : String(d.properties && d.properties.fips ? d.properties.fips : "");
    const countySel = g.selectAll("path")
      .data(counties.features)
      .join("path")
      .attr("class", "county")
      .attr("d", path)
      .attr("stroke", "rgba(0,0,0,0.3)")
      .attr("stroke-width", 0.65)
      .on("mouseenter", function(event, d) {
        const groupFips = featureGroupFips(d);
        countySel.classed("hovered", x => featureGroupFips(x) === groupFips);
        countySel.filter(x => featureGroupFips(x) === groupFips).raise();
        if (stateBorderPath) stateBorderPath.raise();
        const p = d.properties.price;
        const rawName = (d.properties && (d.properties.displayName || d.properties.name || d.properties.NAME))
          ? String(d.properties.displayName || d.properties.name || d.properties.NAME).trim()
          : "Unknown";
        const lsadRaw = d.properties && (d.properties.displayLSAD || d.properties.LSAD) ? String(d.properties.displayLSAD || d.properties.LSAD).trim() : "";
        const lsad = lsadLabel(lsadRaw);
        const countyName = lsad ? `${rawName} ${lsad}` : (/ County$/i.test(rawName) ? rawName : `${rawName} County`);
        const fips = groupFips;
        const stateName = stateNameByFipsPrefix[fips.slice(0, 2)] || "Unknown";
        const le = d.properties.life;
        const mw = d.properties.wage;
        const hr = d.properties.homicide;
        const raceData = d.properties.race;
        const pop = d.properties.population;
        const lines = [];
        lines.push(`<div class="tooltip-title">${countyName}, ${stateName}</div>`);
        if (priceOnEl.checked) {
          lines.push((p == null)
            ? `<span class="tooltip-row"><span class="tooltip-label">Median sale price:</span> <span class="tooltip-value">N/A</span></span>`
            : `<span class="tooltip-row"><span class="tooltip-label">Median sale price:</span> <span class="tooltip-value">${fmt(p)}</span></span>`);
        }
        if (lifeOnEl.checked) {
          lines.push((le == null)
            ? `<span class="tooltip-row"><span class="tooltip-label">Life expectancy:</span> <span class="tooltip-value">N/A</span></span>`
            : `<span class="tooltip-row"><span class="tooltip-label">Life expectancy:</span> <span class="tooltip-value">${le.toFixed(1)} years</span></span>`);
        }
        if (wageOnEl.checked) {
          lines.push((mw == null)
            ? `<span class="tooltip-row"><span class="tooltip-label">Minimum wage:</span> <span class="tooltip-value">N/A</span></span>`
            : `<span class="tooltip-row"><span class="tooltip-label">Minimum wage:</span> <span class="tooltip-value">$${mw.toFixed(2)}</span></span>`);
        }
        if (homicideOnEl.checked) {
          lines.push((hr == null)
            ? `<span class="tooltip-row"><span class="tooltip-label">Homicide rate:</span> <span class="tooltip-value">N/A</span></span>`
            : `<span class="tooltip-row"><span class="tooltip-label">Homicide rate:</span> <span class="tooltip-value">${hr.toFixed(1)} per 100k</span></span>`);
        }
        if (populationOnEl.checked) {
          lines.push((pop == null)
            ? `<span class="tooltip-row"><span class="tooltip-label">Population:</span> <span class="tooltip-value">N/A</span></span>`
            : `<span class="tooltip-row"><span class="tooltip-label">Population:</span> <span class="tooltip-value">${Math.round(pop).toLocaleString('en-US')}</span></span>`);
        }
        if (whiteRaceOnEl.checked) {
          lines.push((raceData == null)
            ? `<span class="tooltip-row"><span class="tooltip-label">White:</span> <span class="tooltip-value">N/A</span></span>`
            : `<span class="tooltip-row"><span class="tooltip-label">White:</span> <span class="tooltip-value">${raceData.white.toFixed(1)}%</span></span>`);
        }
        if (blackRaceOnEl.checked) {
          lines.push((raceData == null)
            ? `<span class="tooltip-row"><span class="tooltip-label">Black:</span> <span class="tooltip-value">N/A</span></span>`
            : `<span class="tooltip-row"><span class="tooltip-label">Black:</span> <span class="tooltip-value">${raceData.black.toFixed(1)}%</span></span>`);
        }
        if (asianRaceOnEl.checked) {
          lines.push((raceData == null)
            ? `<span class="tooltip-row"><span class="tooltip-label">Asian:</span> <span class="tooltip-value">N/A</span></span>`
            : `<span class="tooltip-row"><span class="tooltip-label">Asian:</span> <span class="tooltip-value">${raceData.asian.toFixed(1)}%</span></span>`);
        }
        if (hispanicRaceOnEl.checked) {
          lines.push((raceData == null)
            ? `<span class="tooltip-row"><span class="tooltip-label">Hispanic:</span> <span class="tooltip-value">N/A</span></span>`
            : `<span class="tooltip-row"><span class="tooltip-label">Hispanic:</span> <span class="tooltip-value">${raceData.hispanic.toFixed(1)}%</span></span>`);
        }
        tooltipEl.innerHTML = lines.join("");
        tooltipEl.style.display = "block";
        placeTooltip(event);
      })
      .on("mousemove", function(event) {
        placeTooltip(event);
      })
      .on("mouseleave", function() {
        countySel.classed("hovered", false);
        tooltipEl.style.display = "none";
      });

    const citySel = countySel
      .filter(d => d.properties && d.properties.isCity)
      .attr("stroke", "none")
      .style("pointer-events", "all")
      .raise();

    svg.on("mouseleave", () => {
      countySel.classed("hovered", false);
      tooltipEl.style.display = "none";
    });

    const statesObj = topology.objects && topology.objects.states;
    if (statesObj) {
      const stateBorders = topojson.mesh(topology, statesObj, (a, b) => a !== b);
      stateBorderPath = g.append("path")
        .datum(stateBorders)
        .attr("d", path)
        .attr("fill", "none")
        .attr("stroke", "rgba(0,0,0,0.65)")
        .attr("stroke-width", 1.1)
        .attr("pointer-events", "none");
    }

    function apply() {
      const maxPrice = Number(priceSlider.value);
      const minLife = Number(lifeSlider.value);
      const minWage = Number(wageSlider.value);
      const maxHomicide = Number(homicideSlider.value);
      const [populationMin, populationMax] = normalizeRange(populationMinEl, populationMaxEl);
      const [whiteMin, whiteMax] = normalizeRange(whiteRaceMinEl, whiteRaceMaxEl);
      const [blackMin, blackMax] = normalizeRange(blackRaceMinEl, blackRaceMaxEl);
      const [asianMin, asianMax] = normalizeRange(asianRaceMinEl, asianRaceMaxEl);
      const [hispanicMin, hispanicMax] = normalizeRange(hispanicRaceMinEl, hispanicRaceMaxEl);
      updateDualRangeFill(populationMinEl, populationMaxEl);
      updateDualRangeFill(whiteRaceMinEl, whiteRaceMaxEl);
      updateDualRangeFill(blackRaceMinEl, blackRaceMaxEl);
      updateDualRangeFill(asianRaceMinEl, asianRaceMaxEl);
      updateDualRangeFill(hispanicRaceMinEl, hispanicRaceMaxEl);
      const usePrice = priceOnEl.checked;
      const useLife = lifeOnEl.checked;
      const useWage = wageOnEl.checked;
      const useHomicide = homicideOnEl.checked;
      const usePopulation = populationOnEl.checked;
      const useWhiteRace = whiteRaceOnEl.checked;
      const useBlackRace = blackRaceOnEl.checked;
      const useAsianRace = asianRaceOnEl.checked;
      const useHispanicRace = hispanicRaceOnEl.checked;
      priceValueEl.textContent = fmt(maxPrice);
      lifeValueEl.textContent = `${minLife.toFixed(1)} years`;
      wageValueEl.textContent = `$${minWage.toFixed(2)}`;
      homicideValueEl.textContent = `${maxHomicide.toFixed(1)}`;
      populationValueEl.textContent = `${Math.round(populationMin).toLocaleString('en-US')} - ${Math.round(populationMax).toLocaleString('en-US')}`;
      whiteRaceValueEl.textContent = `${whiteMin.toFixed(1)}% - ${whiteMax.toFixed(1)}%`;
      blackRaceValueEl.textContent = `${blackMin.toFixed(1)}% - ${blackMax.toFixed(1)}%`;
      asianRaceValueEl.textContent = `${asianMin.toFixed(1)}% - ${asianMax.toFixed(1)}%`;
      hispanicRaceValueEl.textContent = `${hispanicMin.toFixed(1)}% - ${hispanicMax.toFixed(1)}%`;
      priceSlider.disabled = !usePrice;
      lifeSlider.disabled = !useLife;
      wageSlider.disabled = !useWage;
      homicideSlider.disabled = !useHomicide;
      populationMinEl.disabled = !usePopulation;
      populationMaxEl.disabled = !usePopulation;
      whiteRaceMinEl.disabled = !useWhiteRace;
      whiteRaceMaxEl.disabled = !useWhiteRace;
      blackRaceMinEl.disabled = !useBlackRace;
      blackRaceMaxEl.disabled = !useBlackRace;
      asianRaceMinEl.disabled = !useAsianRace;
      asianRaceMaxEl.disabled = !useAsianRace;
      hispanicRaceMinEl.disabled = !useHispanicRace;
      hispanicRaceMaxEl.disabled = !useHispanicRace;
      const whiteWrap = whiteRaceMinEl.closest(".dual-range");
      const blackWrap = blackRaceMinEl.closest(".dual-range");
      const asianWrap = asianRaceMinEl.closest(".dual-range");
      const hispanicWrap = hispanicRaceMinEl.closest(".dual-range");
      const populationWrap = populationMinEl.closest(".dual-range");
      if (populationWrap) populationWrap.classList.toggle("is-disabled", !usePopulation);
      if (whiteWrap) whiteWrap.classList.toggle("is-disabled", !useWhiteRace);
      if (blackWrap) blackWrap.classList.toggle("is-disabled", !useBlackRace);
      if (asianWrap) asianWrap.classList.toggle("is-disabled", !useAsianRace);
      if (hispanicWrap) hispanicWrap.classList.toggle("is-disabled", !useHispanicRace);
      let remaining = 0;

      countySel.attr("fill", d => {
        const p = d.properties.price;
        const le = d.properties.life;
        const mw = d.properties.wage;
        const hr = d.properties.homicide;
        const pop = d.properties.population;
        const raceData = d.properties.race;
        const passPrice = !usePrice || (p != null && p <= maxPrice);
        const passLife = !useLife || (le != null && le >= minLife);
        const passWage = !useWage || (mw != null && mw >= minWage);
        const passHomicide = !useHomicide || (hr != null && hr <= maxHomicide);
        const passPopulation = !usePopulation || (pop != null && pop >= populationMin && pop <= populationMax);
        const passWhiteRace = !useWhiteRace || (raceData != null && raceData.white >= whiteMin && raceData.white <= whiteMax);
        const passBlackRace = !useBlackRace || (raceData != null && raceData.black >= blackMin && raceData.black <= blackMax);
        const passAsianRace = !useAsianRace || (raceData != null && raceData.asian >= asianMin && raceData.asian <= asianMax);
        const passHispanicRace = !useHispanicRace || (raceData != null && raceData.hispanic >= hispanicMin && raceData.hispanic <= hispanicMax);
        const match = passPrice && passLife && passWage && passHomicide && passPopulation && passWhiteRace && passBlackRace && passAsianRace && passHispanicRace;
        if (match && !d.properties.isCity) {
          remaining += 1;
        }
        if (match) return getComputedStyle(document.documentElement).getPropertyValue("--accent-green").trim() || "#2f8a6a";
        return "#cfd8dc";
      });
      citySel.raise();
      if (stateBorderPath) stateBorderPath.raise();
      const activeCount = (usePrice ? 1 : 0) + (useLife ? 1 : 0) + (useWage ? 1 : 0) + (useHomicide ? 1 : 0) + (usePopulation ? 1 : 0)
        + (useWhiteRace ? 1 : 0) + (useBlackRace ? 1 : 0) + (useAsianRace ? 1 : 0) + (useHispanicRace ? 1 : 0);
      if (activeCount === 0) {
        setStatus(`All filters off. Showing all counties: ${remaining} out of ${totalCounties}`);
      } else {
        setStatus(`Counties matching ${activeCount} active filter(s): ${remaining} out of ${totalCounties}`);
      }
    }

    priceSlider.addEventListener("input", apply);
    lifeSlider.addEventListener("input", apply);
    wageSlider.addEventListener("input", apply);
    homicideSlider.addEventListener("input", apply);
    populationMinEl.addEventListener("input", apply);
    populationMaxEl.addEventListener("input", apply);
    whiteRaceMinEl.addEventListener("input", apply);
    whiteRaceMaxEl.addEventListener("input", apply);
    blackRaceMinEl.addEventListener("input", apply);
    blackRaceMaxEl.addEventListener("input", apply);
    asianRaceMinEl.addEventListener("input", apply);
    asianRaceMaxEl.addEventListener("input", apply);
    hispanicRaceMinEl.addEventListener("input", apply);
    hispanicRaceMaxEl.addEventListener("input", apply);
    priceOnEl.addEventListener("change", apply);
    lifeOnEl.addEventListener("change", apply);
    wageOnEl.addEventListener("change", apply);
    homicideOnEl.addEventListener("change", apply);
    populationOnEl.addEventListener("change", apply);
    whiteRaceOnEl.addEventListener("change", apply);
    blackRaceOnEl.addEventListener("change", apply);
    asianRaceOnEl.addEventListener("change", apply);
    hispanicRaceOnEl.addEventListener("change", apply);
    apply();
  }).catch(err => {
    setStatus("Error:\n" + (err && err.message ? err.message : String(err)));
    console.error(err);
  });
})();
</script>
</body>
</html>
